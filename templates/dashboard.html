<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Network Monitor Dashboard</title>
    <script src="/static/chart.js"></script>
    <script src="https://unpkg.com/htmx.org"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: linear-gradient(135deg, #f0f4f8 0%, #cfe2f3 100%);
      }
    </style>
  </head>
  <body
    class="min-h-screen font-mono bg-gradient-to-br from-blue-50 to-blue-100"
  >
    <header
      class="mb-8 flex items-center justify-between p-6 rounded-lg shadow-lg bg-white/80 backdrop-blur border-b border-blue-200"
    >
      <h1 class="text-4xl font-bold text-blue-700 tracking-tight drop-shadow">
        Network Monitoring Dashboard
      </h1>
      <span
        class="px-4 py-2 bg-blue-600 text-white rounded-full shadow text-lg font-semibold"
        >Live</span
      >
    </header>

    <main class="container mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-12">
        {% for target in targets %}
        <div
          class="p-8 border border-blue-200 rounded-2xl shadow-xl bg-white/90 hover:scale-[1.02] transition-transform duration-200 max-w-4xl mx-auto"
        >
          <h2
            class="text-2xl font-semibold text-blue-600 mb-4 flex items-center gap-2"
          >
            <svg
              class="w-6 h-6 text-blue-400"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 11c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2zm0 0V7m0 4v4m0-4H8m4 0h4"
              />
            </svg>
            {{ target }}
          </h2>

          <!-- Quality Metrics Cards -->
          <div
            id="metrics-{{ target }}"
            class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4"
          >
            <div
              class="bg-gradient-to-r from-green-50 to-green-100 p-3 rounded-lg border border-green-200"
            >
              <div class="text-xs text-green-600 font-semibold">
                Avg Latency
              </div>
              <div
                class="text-lg font-bold text-green-700"
                id="avg-latency-{{ target }}"
              >
                --
              </div>
            </div>
            <div
              class="bg-gradient-to-r from-yellow-50 to-yellow-100 p-3 rounded-lg border border-yellow-200"
            >
              <div class="text-xs text-yellow-600 font-semibold">Jitter</div>
              <div
                class="text-lg font-bold text-yellow-700"
                id="jitter-{{ target }}"
              >
                --
              </div>
            </div>
            <div
              class="bg-gradient-to-r from-red-50 to-red-100 p-3 rounded-lg border border-red-200"
            >
              <div class="text-xs text-red-600 font-semibold">Packet Loss</div>
              <div
                class="text-lg font-bold text-red-700"
                id="packet-loss-{{ target }}"
              >
                --
              </div>
            </div>
            <div
              class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg border border-blue-200"
            >
              <div class="text-xs text-blue-600 font-semibold">Min/Max</div>
              <div
                class="text-sm font-bold text-blue-700"
                id="min-max-{{ target }}"
              >
                --
              </div>
            </div>
            <div
              class="bg-gradient-to-r from-purple-50 to-purple-100 p-3 rounded-lg border border-purple-200"
            >
              <div class="text-xs text-purple-600 font-semibold">Std Dev</div>
              <div
                class="text-lg font-bold text-purple-700"
                id="std-dev-{{ target }}"
              >
                --
              </div>
            </div>
            <div
              class="bg-gradient-to-r from-gray-50 to-gray-100 p-3 rounded-lg border border-gray-200"
            >
              <div class="text-xs text-gray-600 font-semibold">Status</div>
              <div class="text-sm font-bold" id="status-{{ target }}">
                <span class="text-green-600">●</span> Online
              </div>
            </div>
          </div>
          <div
            hx-get="/api/metrics/{{ target }}"
            hx-trigger="every 5s"
            hx-swap="none"
            class="mb-4 text-gray-500 hidden"
          >
            Loading...
          </div>
          <div class="bg-blue-50 rounded-lg p-4 mb-2">
            <canvas
              id="chart-{{ target }}"
              class="w-full h-80 min-w-[600px]"
            ></canvas>
          </div>
          <script>
            const ctx{{ loop.index }} = document.getElementById('chart-{{ target }}').getContext('2d');
            const chart{{ loop.index }} = new Chart(ctx{{ loop.index }}, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [],
                        fill: false,
                        borderColor: '#2563eb',
                        backgroundColor: '#60a5fa',
                        tension: 0.3,
                        pointRadius: 2,
                        pointBackgroundColor: '#2563eb',
                        yAxisID: 'y',
                    }, {
                        label: 'Jitter (ms)',
                        data: [],
                        fill: false,
                        borderColor: '#f59e0b',
                        backgroundColor: '#fbbf24',
                        tension: 0.3,
                        pointRadius: 2,
                        pointBackgroundColor: '#f59e0b',
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    animation: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                      x: {
                        ticks: {
                          color: '#2563eb',
                          font: { size: 13 },
                        }
                      },
                      y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                          display: true,
                          text: 'Latency (ms)'
                        }
                      },
                      y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                          display: true,
                          text: 'Jitter (ms)'
                        },
                        grid: {
                          drawOnChartArea: false,
                        },
                      }
                    },
                    plugins: {
                      legend: {
                        labels: { color: '#2563eb', font: { size: 14 } }
                      }
                    }
                }
            });

            function formatTime(ts) {
              // Try to parse ISO or fallback
              const d = new Date(ts);
              if (!isNaN(d)) {
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
              }
              return ts;
            }

            function updateMetricsCards(target, metrics) {
              // Update metric cards
              document.getElementById(`avg-latency-${target}`).textContent =
                metrics.average_latency ? `${metrics.average_latency} ms` : '--';
              document.getElementById(`jitter-${target}`).textContent =
                metrics.jitter ? `${metrics.jitter} ms` : '--';
              document.getElementById(`packet-loss-${target}`).textContent =
                `${metrics.packet_loss_percent}%`;
              document.getElementById(`min-max-${target}`).textContent =
                metrics.min_latency && metrics.max_latency ?
                `${metrics.min_latency}/${metrics.max_latency} ms` : '--';
              document.getElementById(`std-dev-${target}`).textContent =
                metrics.std_deviation ? `${metrics.std_deviation} ms` : '--';

              // Update status
              const statusElement = document.getElementById(`status-${target}`);
              if (metrics.packet_loss_percent === 100) {
                statusElement.innerHTML = '<span class="text-red-600">●</span> Offline';
              } else if (metrics.packet_loss_percent > 5) {
                statusElement.innerHTML = '<span class="text-yellow-600">●</span> Poor';
              } else {
                statusElement.innerHTML = '<span class="text-green-600">●</span> Online';
              }
            }

            async function updateChart() {
                const res = await fetch('/api/metrics/{{ target }}');
                const data = await res.json();
                const labels = data.records.map(r => formatTime(r.timestamp));
                const latencies = data.records.map(r => r.latency ?? 0);

                // Calculate jitter for each point (simplified version for visualization)
                const jitterData = [];
                for (let i = 1; i < latencies.length; i++) {
                  if (latencies[i] !== 0 && latencies[i-1] !== 0) {
                    jitterData.push(Math.abs(latencies[i] - latencies[i-1]));
                  } else {
                    jitterData.push(0);
                  }
                }
                jitterData.unshift(0); // First point has no jitter

                chart{{ loop.index }}.data.labels = labels;
                chart{{ loop.index }}.data.datasets[0].data = latencies;
                chart{{ loop.index }}.data.datasets[1].data = jitterData;
                chart{{ loop.index }}.update('none');

                // Update metrics cards
                updateMetricsCards('{{ target }}', data);
            }
            setInterval(updateChart, 5000);
            updateChart(); // Initial load
          </script>
        </div>
        {% endfor %}
      </div>
    </main>
  </body>
</html>
